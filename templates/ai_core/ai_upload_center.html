{% extends 'base.html' %}
{% load i18n %}
{% load crispy_forms_tags %}

{% block title %}AI Upload Center | {% trans 'Learning management system' %}{% endblock title %}

{% block header %}
<style>
/* Custom styles for AI Upload Center */
.drag-drop-zone {
    border: 2px dashed #cbd5e1;
    border-radius: 8px;
    padding: 3rem 1rem;
    text-align: center;
    background-color: #f8fafc;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.drag-drop-zone:hover, .drag-drop-zone.dragover {
    border-color: #3b82f6;
    background-color: #eff6ff;
}

.drag-drop-zone input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.upload-icon {
    font-size: 2.5rem;
    color: #94a3b8;
    margin-bottom: 1rem;
}

.info-card {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1.5rem;
    height: 100%;
    background-color: #ffffff;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
}

.info-card-icon {
    font-size: 1.5rem;
    color: #3b82f6;
    margin-bottom: 1rem;
    display: inline-block;
}
.info-card-icon-secure { color: #0ea5e9; }
.info-card-icon-fast { color: #6366f1; }
.info-card-icon-custom { color: #8b5cf6; }

.info-card-title {
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
    color: #1e293b;
}

.info-card-text {
    color: #64748b;
    font-size: 0.9rem;
    line-height: 1.5;
}

.alert-ai-info {
    background-color: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: 8px;
    color: #166534;
}
.alert-ai-info .alert-heading {
    color: #15803d;
    font-weight: 600;
    font-size: 1.05rem;
}

/* Loader Styles */
#loader-overlay {
    background: rgba(255, 255, 255, 0.95);
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    display: none; /* hidden by default */
}

.spinner-border-ai {
    width: 3rem;
    height: 3rem;
    border-width: 0.25em;
    color: #3b82f6;
}

#loader-status-text {
    margin-top: 1.5rem;
    font-size: 1.1rem;
    font-weight: 500;
    color: #1e293b;
    transition: opacity 0.3s;
}

#loader-progress-bar-container {
    width: 60%;
    max-width: 400px;
    height: 6px;
    background-color: #e2e8f0;
    border-radius: 4px;
    margin-top: 1rem;
    overflow: hidden;
}

#loader-progress-bar {
    height: 100%;
    background-color: #3b82f6;
    width: 0%;
    transition: width 0.5s ease;
}

.sparkle-icon {
    display: none;
    font-size: 2.5rem;
    color: #eab308;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
}

.btn-ai-process {
    background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
    border: none;
    color: white;
    font-weight: 500;
    padding: 0.6rem 1.5rem;
    border-radius: 6px;
    transition: opacity 0.3s;
}
.btn-ai-process:hover {
    color: white;
    opacity: 0.9;
}

</style>
{% endblock header %}

{% block content %}

<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">{% trans 'Home' %}</a></li>
        <li class="breadcrumb-item">{% trans 'Lectures' %}</li>
        <li class="breadcrumb-item active" aria-current="page">{% trans 'AI Upload Center' %}</li>
    </ol>
</nav>

<h4 class="mb-4">AI Upload Center</h4>

<!-- Main Form Card -->
<div class="card shadow-sm mb-4 border-0" style="position: relative;">
    
    <!-- Loader Overlay inside the card -->
    <div id="loader-overlay">
        <div class="spinner-border spinner-border-ai" role="status" id="loading-spinner">
            <span class="visually-hidden">Loading...</span>
        </div>
        <i class="fas fa-wand-magic-sparkles sparkle-icon" id="magic-icon"></i>
        
        <div id="loader-status-text">Uploading file...</div>
        
        <div id="loader-progress-bar-container">
            <div id="loader-progress-bar"></div>
        </div>
        <p class="text-muted small mt-2" id="loader-subtext">Please don't close this window</p>
    </div>


    <div class="card-body p-4 p-md-5">
        
        <div class="mb-4">
            <h5 class="card-title fw-bold mb-2">{% trans 'Upload Files for AI Processing' %}</h5>
            <p class="text-muted small">
                {% trans 'Upload your lecture materials, documents, or videos to leverage AI-powered processing. Select your desired AI task and let our system handle the rest.' %}
            </p>
        </div>

        <div class="alert alert-ai-info d-flex align-items-start mb-4" role="alert">
            <i class="fas fa-info-circle me-3 mt-1 fs-5"></i>
            <div>
                <div class="alert-heading">{% trans 'Data Security & AI Processing:' %}</div>
                <p class="mb-1 small">
                    {% trans 'Your uploaded files will be processed securely using AI technology. We encrypt all data in transit and at rest. Files are automatically deleted after processing. The AI will only use your content for the selected task and will not store or train on your data.' %}
                </p>
                <a href="#" class="alert-link small">Privacy Policy</a>
            </div>
        </div>

        <!-- Start Form -->
        <form id="ai-upload-form" action="" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="mb-4">
                <label for="ai-goal-select" class="form-label fw-bold small">{% trans 'Select AI Processing Goal' %}</label>
                <select class="form-select border-2" id="ai-goal-select" name="ai_goal">
                    <option value="summarize">Summarize Document</option>
                    <option value="generate_lesson">Generate Lesson</option>
                    <option value="generate_quiz">Generate Quiz Questions</option>
                    <option value="extract_keywords">Extract Key Concepts</option>
                </select>
                <div class="form-text small">Accepted formats: .pdf, .docx, .txt | Max size: 50MB</div>
            </div>

            <div class="mb-4">
                <label class="form-label fw-bold small">{% trans 'Upload File' %}</label>
                <div class="drag-drop-zone" id="drop-zone">
                    <input type="file" id="file-input" name="document_file" multiple required>
                    <i class="fas fa-arrow-up-from-bracket upload-icon"></i>
                    <p class="mb-2">{% trans 'Drag and drop your files here, or' %}</p>
                    <button type="button" class="btn btn-primary btn-sm px-4 rounded-pill">{% trans 'Browse Files' %}</button>
                </div>
                <!-- Container for displaying multiple selected files -->
                <div id="file-list-display" class="mt-3 d-flex flex-wrap gap-2"></div>
            </div>

            <div class="mb-4">
                 <a href="#advancedSettings" data-bs-toggle="collapse" class="text-decoration-none small fw-bold">
                    <i class="fas fa-plus me-1"></i> {% trans 'Show Advanced Settings' %}
                </a>
                <div class="collapse mt-3" id="advancedSettings">
                    <div class="card card-body bg-light border-0">
                         <div class="mb-3">
                            <label for="detailLevel" class="form-label small">Detail Level</label>
                            <select class="form-select form-select-sm" id="detailLevel" name="detail_level">
                                <option value="standard">Standard</option>
                                <option value="detailed">Very Detailed</option>
                                <option value="concise">Concise / Summary</option>
                            </select>
                        </div>
                        <div class="mb-0">
                             <label for="outputLanguage" class="form-label small">Output Language</label>
                            <select class="form-select form-select-sm" id="outputLanguage" name="output_language">
                                <option value="en">English (Default)</option>
                                <option value="vi">Vietnamese</option> 
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-ai-process px-4" id="btn-submit">
                {% trans 'Process with AI' %}
            </button>
        </form>

    </div>
</div>

<!-- Info Cards Row -->
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="info-card">
            <i class="fas fa-shield-halved info-card-icon info-card-icon-secure"></i>
            <h6 class="info-card-title">Secure Processing</h6>
            <p class="info-card-text mb-0">All files are encrypted and processed in secure environments. Deleted after completion.</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="info-card">
            <i class="fas fa-bolt info-card-icon info-card-icon-fast"></i>
            <h6 class="info-card-title">Fast AI Processing</h6>
            <p class="info-card-text mb-0">Our AI models process your content quickly with high accuracy and reliability.</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="info-card">
            <i class="fas fa-sliders info-card-icon info-card-icon-custom"></i>
            <h6 class="info-card-title">Customizable Output</h6>
            <p class="info-card-text mb-0">Choose from various output formats and quality settings to meet your exact needs.</p>
        </div>
    </div>
</div>


{% endblock content %}

{% block js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileListDisplay = document.getElementById('file-list-display');
        const form = document.getElementById('ai-upload-form');
        const loaderOverlay = document.getElementById('loader-overlay');
        const statusText = document.getElementById('loader-status-text');
        const progressBar = document.getElementById('loader-progress-bar');
        const spinner = document.getElementById('loading-spinner');
        const magicIcon = document.getElementById('magic-icon');
        const subtext = document.getElementById('loader-subtext');

        // Handle Drag and Drop visual cues
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
        });

        // Handle file selection (both drop and click)
        dropZone.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFiles, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            if(dt.files.length > 0) {
                 fileInput.files = dt.files;
                 updateFileList(dt.files);
            }
        }

        function handleFiles() {
            if(fileInput.files.length > 0) {
                updateFileList(fileInput.files);
            }
        }

        function updateFileList(files) {
            fileListDisplay.innerHTML = ''; // Clear existing
            
            Array.from(files).forEach(file => {
                const pill = document.createElement('div');
                pill.className = 'badge bg-white text-dark border p-2 d-flex align-items-center shadow-sm rounded-pill';
                
                // Determine icon based on file type roughly
                let iconClass = 'fa-file-alt text-primary';
                if(file.name.endsWith('.pdf')) iconClass = 'fa-file-pdf text-danger';
                if(file.name.endsWith('.docx') || file.name.endsWith('.doc')) iconClass = 'fa-file-word text-primary';
                
                pill.innerHTML = `
                    <i class="fas ${iconClass} me-2 fs-5"></i> 
                    <span class="text-truncate" style="max-width: 200px;">${file.name}</span>
                    <span class="text-muted ms-2 small">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                `;
                fileListDisplay.appendChild(pill);
            });
        }

        // Handle Form Submission with Fetch and Fake Multi-step Loader
        form.addEventListener('submit', function(e) {
            e.preventDefault(); 
            
            // Show loader
            loaderOverlay.style.display = 'flex';
            
            // Reset loader state
            progressBar.style.width = '0%';
            spinner.style.display = 'inline-block';
            magicIcon.style.display = 'none';
            statusText.innerText = 'Submitting your file to the server...';
            subtext.innerText = 'Please don\'t close this window';

            const formData = new FormData(form);
            
            // Actual API Call to backend
            fetch('{% url "ai_core:process_ai_document" %}', {
                method: 'POST',
                body: formData,
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if(data.status === 'success') {
                    // Start Fake Progress Sequence for AI Processing (since actual Celery polling isn't built yet)
                    const sequence = [
                        { progress: 20, time: 500, text: 'File saved. Extracting text content from document...' },
                        { progress: 50, time: 2000, text: 'Preparing data for AI...' },
                        { progress: 70, time: 3500, action: () => {
                            spinner.style.display = 'none';
                            magicIcon.style.display = 'inline-block';
                            statusText.innerText = 'AI is analyzing and processing your content...';
                        }},
                        { progress: 85, time: 6000, text: 'Generating final results...' },
                        { progress: 100, time: 8000, action: () => {
                            magicIcon.className = 'fas fa-check-circle text-success fs-1 mb-3';
                            statusText.innerHTML = '<span class="text-success fw-bold">Processing Complete!</span>';
                            subtext.innerText = 'Redirecting to results...';
                            
                            // Simulate redirect after success
                            setTimeout(() => {
                                loaderOverlay.style.display = 'none';
                                alert("Files have been successfully uploaded and saved with AIGeneration IDs: " + data.generation_ids.join(", "));
                                
                                // Reset for demo purposes
                                magicIcon.className = 'fas fa-wand-magic-sparkles sparkle-icon';
                                fileInput.value = '';
                                fileListDisplay.innerHTML = '';
                            }, 2000);
                        }}
                    ];

                    sequence.forEach(step => {
                        setTimeout(() => {
                            progressBar.style.width = step.progress + '%';
                            if (step.text) {
                                // Fade text effect
                                statusText.style.opacity = 0;
                                setTimeout(() => {
                                    statusText.innerText = step.text;
                                    statusText.style.opacity = 1;
                                }, 300);
                            }
                            if (step.action) step.action();
                        }, step.time);
                    });
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            })
            .catch(error => {
                // Handle Error
                spinner.style.display = 'none';
                magicIcon.className = 'fas fa-times-circle text-danger fs-1 mb-3';
                statusText.innerHTML = '<span class="text-danger fw-bold">Upload Failed</span>';
                subtext.innerText = 'Error: ' + error.message;
                progressBar.style.backgroundColor = '#ef4444'; // red progress bar
                progressBar.style.width = '100%';
                
                setTimeout(() => {
                     loaderOverlay.style.display = 'none';
                     progressBar.style.backgroundColor = '#3b82f6'; // reset 
                }, 3000);
            });

        });
    });
</script>
{% endblock js %}
